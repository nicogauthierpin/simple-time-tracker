<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Timer</title>

    <script type="text/javascript">


      /*
      ================================
       TICKER
      ================================
      */

      function tick() {
        // Loop through all timers
        for (var key of Object.keys(timers)) {
          // If timer is running...
          if (timers[key].running) {
            // Calculate the elapsed time by the difference of the last tick and now
            var elapsed = (Date.now() - timers[key].lastTick);
            // Reset the last tick
            timers[key].lastTick = Date.now();
            // Add the accumulated time
            timers[key].totalTime = parseInt(timers[key].totalTime) + elapsed;
            // Update the displayed time. This is the only place where a view update happens outside a full redraw, for performace sake.
            document.querySelector('.timer[data-id="'+key+'"] span.totaltime').innerText = toHrsMins(Math.floor(timers[key].totalTime/60000));
          }
        }
        // update localStorage for data persistence
        window.localStorage.setItem('timersString', JSON.stringify(timers));
        console.log('Update Local');
      }

      /*
      ================================
       HELPER FUNCTIONS
      ================================
      */

      function redraw() {
        // Remove old nodes
        document.getElementById("timers").replaceChildren();
        
        // Loop through all data and recreate nodes
        for (var key of Object.keys(timers)) {

          // Build nodes
          const newTimer = document.createElement("div");
          newTimer.setAttribute('class','timer');
          newTimer.dataset.id = key;

          const title = document.createElement("input");
          title.value = timers[key].title;

          const description = document.createElement("textarea");
          description.value = timers[key].description;

          const start = document.createElement("button");
          start.innerText="Start";
          start.setAttribute('class','action-start');

          const stop = document.createElement("button");
          stop.innerText="Stop";
          stop.setAttribute('class','action-stop');

          const remove = document.createElement("button");
          remove.innerText="Remove";
          remove.setAttribute('class','action-remove');

          const status = document.createElement("span");
          status.setAttribute('class','status');
          status.innerText = timers[key].running ? ' [running] ' : '';

          const elapsed = document.createElement("span");
          elapsed.setAttribute('class','totaltime');
          elapsed.innerText = toHrsMins(Math.floor(timers[key].totalTime/60000));

          // Append HTML elements
          document.getElementById("timers").appendChild(newTimer);
          newTimer.appendChild(title);
          newTimer.appendChild(description);
          newTimer.appendChild(start);
          newTimer.appendChild(stop);
          newTimer.appendChild(remove);
          newTimer.appendChild(status);
          newTimer.appendChild(elapsed);
        }
      }

      function toHrsMins(time) {
          let hours = Math.floor(time / 60);
          let minutes = time % 60;
          minutes = minutes < 10 ? '0'+ minutes : minutes;
          return hours + ':' + minutes;
      }

      /*
      ================================
       EVENT HANDLERS
      ================================
      */

      function clickHandler() {
        switch (event.target.className) {
          case 'action-start':
            // Set all running flags to false
            for (var key of Object.keys(timers)) {
              timers[key].running = false;
            }
            // Set running flag to true and last tick to now
            timers[event.srcElement.parentElement.dataset.id].running = true;
            timers[event.srcElement.parentElement.dataset.id].lastTick = Date.now();
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            console.log('Update Local');
            // Redraw
            redraw();
            break;

          case 'action-stop':
            // Set all running flags to false
            for (var key of Object.keys(timers)) {
              timers[key].running = false;
            }
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            console.log('Update Local');
            // Redraw
            redraw();
            break;

          case 'action-remove':
            // Remove selected timer
            timers.splice(event.srcElement.parentElement.dataset.id,1);
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            console.log('Update Local');
            // Redraw
            redraw();
            break;

          case 'action-add':
            // Find the highest key, add one and clone the default timer object
            const highestKey = Math.max(...Object.keys(timers));
            newKey = Object.keys(timers).length > 0 ? highestKey + 1 : 1;
            timers[newKey] = JSON.parse(JSON.stringify(defaultTimer));
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            console.log('Update Local');
            // Redraw
            redraw();
            break;

          case 'action-clear-all':
            // Clear timers object
            timers.length = 0;
            // (Clone the default value into timers)
            timers[0] = JSON.parse(JSON.stringify(defaultTimer));
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            console.log('Update Local');
            // Redraw
            redraw();
            break;

          }
      }

      function focusOutHandler() {
        // Save any updates to the title and description on focus out
        if(event.target.localName == 'input' || event.target.localName == 'textarea') {
          for (var key of Object.keys(timers)) {
            timers[key].title = document.querySelector('.timer[data-id="'+key+'"] input').value;
            timers[key].description = document.querySelector('.timer[data-id="'+key+'"] textarea').value;
          }
        }
      }


      /*
      ================================
       INITIALIZE
      ================================
      */

        // Initialize global variables.
        let timers = [];

        // Define a default timer object
        const defaultTimer = {
                'title' : '',
                'description' : '',
                'running': false,
                'lastTick': null,
                'totalTime':'0'
            };

        // Check for existing timer data saved in localStorage. If data already exists, use it. Otherwise use the default.
        if (window.localStorage.getItem('timersString') != null) {
          timers = JSON.parse(window.localStorage.getItem('timersString'));
        } else {
          // Clone the default value into timers, using a little json workaround.
          timers[0] = JSON.parse(JSON.stringify(defaultTimer));
        }

      /*
      ================================
       RUN
      ================================
      */

      window.addEventListener('DOMContentLoaded', function() {
          redraw();
          setInterval(tick, 20000); // 20 seconds tick interval, more than enough since the time is only displayed in minutes.
          document.body.addEventListener('click', clickHandler);
          document.body.addEventListener('focusout', focusOutHandler); // foucusout instead of blur, because blur doesn't bubble
      });



    </script>

    <style media="screen">

    </style>

  </head>
  <body>
      <button type="button" class="action-add">Add Timer</button>
      <button type="button" class="action-clear-all">Clear All Timers</button>
      <div id="timers">
      </div>
  </body>
</html>
