<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Timer</title>

    <style media="screen">
      body {
        background-color: #eaeaea;
        font-family: Arial, sans-serif;
        font-size: 16px;
        margin: 0;
      }

      #timers {
        width: 90%;
        max-width: 480px;
        margin: 1em auto;
      }
      .timer {
        position: relative;
        margin-bottom: 1.25em;
        background: #fff;
        padding: 1em;
        border-radius: 6px;
        box-shadow: 3px 3px 9px #0000003d;
      }

      .buttonswrap {
        margin-bottom: 0.5em;
      }

      button {
        border: none;
        background: #386faf;
        color: #ffffff;
        border-radius: 6px;
        height: 32px;
        width: 64px;
        padding: 0;
        font-weight: bold;
        cursor: pointer;
        background-size: 21px;
        background-repeat: no-repeat;
        background-position: center;
      }

      /* 
        SVG icons by Fontawesome - fontawesome.com
        URLs must be escaped when using inline SVGs in css backgrounds. e.g. # -> %23
      */

      button.action-start {
        background-color: #858984;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M188.3 147.1C195.8 142.8 205.1 142.1 212.5 147.5L356.5 235.5C363.6 239.9 368 247.6 368 256C368 264.4 363.6 272.1 356.5 276.5L212.5 364.5C205.1 369 195.8 369.2 188.3 364.9C180.7 360.7 176 352.7 176 344V167.1C176 159.3 180.7 151.3 188.3 147.1V147.1zM512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256zM256 48C141.1 48 48 141.1 48 256C48 370.9 141.1 464 256 464C370.9 464 464 370.9 464 256C464 141.1 370.9 48 256 48z" fill="%23ffffff" /></svg>');
      }

      button.action-stop {
        background-color: #a14848;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M200 160C186.8 160 176 170.8 176 184v144C176 341.3 186.8 352 200 352S224 341.3 224 328v-144C224 170.8 213.3 160 200 160zM312 160C298.8 160 288 170.8 288 184v144c0 13.25 10.75 24 24 24s24-10.75 24-24v-144C336 170.8 325.3 160 312 160zM256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 464c-114.7 0-208-93.31-208-208S141.3 48 256 48s208 93.31 208 208S370.7 464 256 464z" fill="%23ffffff"/></svg>');
        display: none;
      }

      button.action-edit {
        float: right;
        height: 24px;
        width: 36px;
        margin-top: 4px;
      }

      button.action-edit-close {
        height: 24px;
        width: 36px;
        margin-top: 4px;
        position: absolute;
        top: 1em;
        right: 1em;
      }
 
      button.action-change-time {
        margin-right: 4px;
      }

      button.action-remove {
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.69C140.6 6.848 151.7 0 163.8 0H284.2C296.3 0 307.4 6.848 312.8 17.69L320 32H416C433.7 32 448 46.33 448 64C448 81.67 433.7 96 416 96H32C14.33 96 0 81.67 0 64C0 46.33 14.33 32 32 32H128L135.2 17.69zM31.1 128H416V448C416 483.3 387.3 512 352 512H95.1C60.65 512 31.1 483.3 31.1 448V128zM111.1 208V432C111.1 440.8 119.2 448 127.1 448C136.8 448 143.1 440.8 143.1 432V208C143.1 199.2 136.8 192 127.1 192C119.2 192 111.1 199.2 111.1 208zM207.1 208V432C207.1 440.8 215.2 448 223.1 448C232.8 448 240 440.8 240 432V208C240 199.2 232.8 192 223.1 192C215.2 192 207.1 199.2 207.1 208zM304 208V432C304 440.8 311.2 448 320 448C328.8 448 336 440.8 336 432V208C336 199.2 328.8 192 320 192C311.2 192 304 199.2 304 208z"  fill="%23ffffff"/></svg>');
        background-size: 12px;
        background-color: #a14848;
        position: absolute;
        bottom: 1em;
        right: 1em;
      }
      
      button.action-add {
        display: block;
        width: 90%;
        max-width: 480px;
        margin: 0 auto;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256zM256 368C269.3 368 280 357.3 280 344V280H344C357.3 280 368 269.3 368 256C368 242.7 357.3 232 344 232H280V168C280 154.7 269.3 144 256 144C242.7 144 232 154.7 232 168V232H168C154.7 232 144 242.7 144 256C144 269.3 154.7 280 168 280H232V344C232 357.3 242.7 368 256 368z" fill="%23ffffff"/></svg>');
      }
      
      button.action-clear-all {
        width: 160px;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.69C140.6 6.848 151.7 0 163.8 0H284.2C296.3 0 307.4 6.848 312.8 17.69L320 32H416C433.7 32 448 46.33 448 64C448 81.67 433.7 96 416 96H32C14.33 96 0 81.67 0 64C0 46.33 14.33 32 32 32H128L135.2 17.69zM31.1 128H416V448C416 483.3 387.3 512 352 512H95.1C60.65 512 31.1 483.3 31.1 448V128zM111.1 208V432C111.1 440.8 119.2 448 127.1 448C136.8 448 143.1 440.8 143.1 432V208C143.1 199.2 136.8 192 127.1 192C119.2 192 111.1 199.2 111.1 208zM207.1 208V432C207.1 440.8 215.2 448 223.1 448C232.8 448 240 440.8 240 432V208C240 199.2 232.8 192 223.1 192C215.2 192 207.1 199.2 207.1 208zM304 208V432C304 440.8 311.2 448 320 448C328.8 448 336 440.8 336 432V208C336 199.2 328.8 192 320 192C311.2 192 304 199.2 304 208z"  fill="%23ffffff"/></svg>');
        background-position: 14px 7px;
        background-size: 13px;
        padding-left: 20px;
        position: absolute;
        bottom: 10px;
        right: 10px;
      }

      .timer.running button.action-start {
        display: none;
      }

      .timer.running button.action-edit {
        display: none;
      }

      .timer.running button.action-stop {
        display: inline;
      }
      
      @keyframes blinker {
        50% {
          opacity: 0;
        }
      }

      .totaltime {
        margin-left: 0.25em;
        font-size: 21px;
        font-weight: bold;
        height: 32px;
        line-height: 32px;
        display: inline-block;
        vertical-align: top;
      }

      .timer.running .totaltime {
        animation: blinker 2s linear infinite;
      }

      .timer.editing .totaltime {
        display: block;
        margin: 1em 0;
      }


      input,textarea {
        border: 1px solid #c0c0c0;
        border-radius: 6px;
        padding: 9px;
        display: block;
        width: calc(100% - 14px);
        margin-bottom: 0.5em;
        font-family: Arial, sans-serif;
      }

      textarea {
        height: 6em;
      }

      input,textarea:focus {
        outline: none;
      }

      .editwrap {
        display: none;
        position: absolute;
        background: #fff;
        height: calc(100% - 2em);
        width: calc(100% - 2em);
        top: 0;
        left: 0;
        border-radius: 6px;
        padding: 1em;
        text-align: center;
      }
      
      .timer.editing .editwrap {
        display: block;
      }

    </style>


    <script type="text/javascript">


      /*
      ================================
       TICKER
      ================================
      */

      function tick() {
        // Loop through all timers
        for (var key of Object.keys(timers)) {
          // If timer is running...
          if (timers[key].running) {
            // Calculate the elapsed time by the difference of the last tick and now
            var elapsed = (Date.now() - timers[key].lastTick);
            // Reset the last tick
            timers[key].lastTick = Date.now();
            // Add the accumulated time. This is in miliseconds.
            timers[key].totalTime = parseInt(timers[key].totalTime) + elapsed;
            // Update the displayed time. This is the only place where a view update happens outside a full redraw, for performace sake.
            document.querySelector('.timer[data-id="'+key+'"] span.totaltime').innerText = toHrsMins(Math.floor(timers[key].totalTime/60000));
          }
        }
        // update localStorage for data persistence
        window.localStorage.setItem('timersString', JSON.stringify(timers));
        console.log('Update Local');
      }

      /*
      ================================
       HELPER FUNCTIONS
      ================================
      */

      function redraw() {
        // Remove old nodes
        document.getElementById("timers").replaceChildren();
        
        // Loop through all data and recreate nodes
        for (var key of Object.keys(timers)) {

          // Build nodes
          const newTimer = document.createElement("div");
          newTimer.classList.add('timer');
          if(timers[key].running) {
            newTimer.classList.add('running');
          }
          if(timers[key].editing) {
            newTimer.classList.add('editing');
          }
          newTimer.dataset.id = key;

          const textWrap = document.createElement("div");
          textWrap.classList.add("textwrap");
          const buttonsWrap = document.createElement("div");
          buttonsWrap.classList.add("buttonswrap");

          const editWrap = document.createElement("div");
          editWrap.classList.add("editwrap");

          const title = document.createElement("input");
          title.value = timers[key].title;

          const description = document.createElement("textarea");
          description.value = timers[key].description;

          const startButton= document.createElement("button");
          startButton.classList.add('action-start');

          const stop = document.createElement("button");
          stop.classList.add('action-stop');

          const editButton= document.createElement("button");
          editButton.classList.add('action-edit');
          editButton.textContent = "Edit";

          const editCloseButton= document.createElement("button");
          editCloseButton.classList.add('action-edit-close');
          editCloseButton.textContent = "X";


          const plus1Button= document.createElement("button");
          plus1Button.classList.add('action-change-time');
          plus1Button.textContent = "+1";

          const plus5Button= document.createElement("button");
          plus5Button.classList.add('action-change-time');
          plus5Button.textContent = "+5";

          const plus15Button= document.createElement("button");
          plus15Button.classList.add('action-change-time');
          plus15Button.textContent = "+15";

          const minus1Button= document.createElement("button");
          minus1Button.classList.add('action-change-time');
          minus1Button.textContent = "-1";

          const minus5Button= document.createElement("button");
          minus5Button.classList.add('action-change-time');
          minus5Button.textContent = "-5";

          const minus15Button= document.createElement("button");
          minus15Button.classList.add('action-change-time');
          minus15Button.textContent = "-15";

          const removeButton= document.createElement("button");
          removeButton.classList.add('action-remove');

          const elapsed = document.createElement("span");
          elapsed.classList.add('totaltime');
          elapsed.innerText = toHrsMins(Math.floor(timers[key].totalTime/60000));

          // Append HTML elements
          document.getElementById("timers").appendChild(newTimer);

          newTimer.appendChild(buttonsWrap);
            buttonsWrap.appendChild(startButton);
            buttonsWrap.appendChild(stop);
            buttonsWrap.appendChild(elapsed);
            buttonsWrap.appendChild(editButton);
          newTimer.appendChild(textWrap);
            textWrap.appendChild(title);
            textWrap.appendChild(description);
          
          // Only render the edit window if "editing" flag is true. The original content must always be rendered to keep the original div size.
          if(timers[key].editing) {
            newTimer.appendChild(editWrap);
              editWrap.appendChild(minus1Button);
              editWrap.appendChild(minus5Button);
              editWrap.appendChild(minus15Button);
              editWrap.appendChild(elapsed);
              editWrap.appendChild(plus1Button);
              editWrap.appendChild(plus5Button);
              editWrap.appendChild(plus15Button);
              editWrap.appendChild(editCloseButton);
              editWrap.appendChild(removeButton);
          }
        }
      }

      function toHrsMins(time) {
          let hours = Math.floor(time / 60);
          let minutes = time % 60;
          minutes = minutes < 10 ? '0'+ minutes : minutes;
          return hours + ':' + minutes;
      }

      /*
      ================================
       EVENT HANDLERS
      ================================
      */

      function clickHandler() {
        console.log(event.target.innerText);
        switch (event.target.className) {
          case 'action-start':
            // Set all running flags to false
            for (var key of Object.keys(timers)) {
              timers[key].running = false;
            }
            // Set running flag to true and last tick to now
            timers[event.srcElement.parentElement.parentElement.dataset.id].running = true;
            timers[event.srcElement.parentElement.parentElement.dataset.id].lastTick = Date.now();
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            // Redraw
            redraw();
            break;

          case 'action-stop':
            // Set all running flags to false
            for (var key of Object.keys(timers)) {
              timers[key].running = false;
            }
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            // Redraw
            redraw();
            break;

          case 'action-edit':
            // Set editing flag to true
            timers[event.srcElement.parentElement.parentElement.dataset.id].editing = true;
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            // Redraw
            redraw();
            break;

          case 'action-edit-close':
            // Set editing flag to false
            timers[event.srcElement.parentElement.parentElement.dataset.id].editing = false;
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            // Redraw
            redraw();
            break;

          case 'action-change-time':
            switch(event.target.innerText) {
              case '+1':
                // Add 60000 miliseconds (1 second) to the total time
                timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime = Number(timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime) + 60000;
                break;
              case '+5':
                // Add 300000 miliseconds (5 second) to the total time
                timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime = Number(timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime) + 300000;
                break;
              case '+15':
                // Add 900000 miliseconds (1 second) to the total time
                timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime = Number(timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime) + 900000;
                break;
              case '-1':
                // Remove 60000 miliseconds (1 second) from the total time
                timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime = Number(timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime) - 60000;
                break;
              case '-5':
                // Remove 300000 miliseconds (5 second) from the total time
                timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime = Number(timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime) - 300000;
                break;
              case '-15':
                // Remove 900000 miliseconds (1 second) from the total time
                timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime = Number(timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime) - 900000;
                break;
            }
            // Reset the timer to zero if it's negative (meaning more than what was available ws removed)
            if (Number(timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime) < 0) {
              timers[event.srcElement.parentElement.parentElement.dataset.id].totalTime = 0;
            }
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            // Redraw
            redraw();
            break;


          case 'action-remove':
            console.log('REMOVE');
            // Remove selected timer
            timers.splice(event.srcElement.parentElement.parentElement.dataset.id,1);
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            // Redraw
            redraw();
            break;

          case 'action-add':
            // Find the highest key, add one and clone the default timer object
            const highestKey = Math.max(...Object.keys(timers));
            newKey = Object.keys(timers).length > 0 ? highestKey + 1 : 1;
            timers[newKey] = JSON.parse(JSON.stringify(defaultTimer));
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            // Redraw
            redraw();
            break;

          case 'action-clear-all':
            // Clear timers object
            timers.length = 0;
            // (Clone the default value into timers)
            timers[0] = JSON.parse(JSON.stringify(defaultTimer));
            // update localStorage for data persistence
            window.localStorage.setItem('timersString', JSON.stringify(timers));
            // Redraw
            redraw();
            break;

          }
      }

      function focusOutHandler() {
        // Save any updates to the title and description on focus out
        if(event.target.localName == 'input' || event.target.localName == 'textarea') {
          for (var key of Object.keys(timers)) {
            timers[key].title = document.querySelector('.timer[data-id="'+key+'"] input').value;
            timers[key].description = document.querySelector('.timer[data-id="'+key+'"] textarea').value;
          }
        }
      }


      /*
      ================================
       INITIALIZE
      ================================
      */

        // Initialize global variables.
        let timers = [];

        // Define a default timer object
        const defaultTimer = {
                'title' : '',
                'description' : '',
                'running': false,
                'editing': false,
                'lastTick': null,
                'totalTime':'0'
            };

        // Check for existing timer data saved in localStorage. If data already exists, use it. Otherwise use the default.
        if (window.localStorage.getItem('timersString') != null) {
          timers = JSON.parse(window.localStorage.getItem('timersString'));
        } else {
          // Clone the default value into timers, using a little json workaround.
          timers[0] = JSON.parse(JSON.stringify(defaultTimer));
        }

      /*
      ================================
       RUN
      ================================
      */

      window.addEventListener('DOMContentLoaded', function() {
          redraw();
          setInterval(tick, 20000); // 20 seconds tick interval, more than enough since the time is only displayed in minutes.
          document.body.addEventListener('click', clickHandler);
          document.body.addEventListener('focusout', focusOutHandler); // foucusout instead of blur, because blur doesn't bubble
      });



    </script>

  </head>
  <body>
      <button type="button" class="action-clear-all">Clear All Timers</button>
      <div id="timers">
      </div>
      <button type="button" class="action-add"></button>
  </body>
</html>
