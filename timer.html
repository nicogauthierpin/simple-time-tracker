<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Timer</title>

    <script type="text/javascript">


    /*
    ================================
     INITIALIZE
    ================================
    */

      // Initialize global variables.
      let timers;

      // Define a default timer object
      const defaultTimers = { '0' :
            {
              'title' : '',
              'description' : '',
              'running': false,
              'lastTick': null,
              'totalTime':'0'
            }
          };

      // Check for existing timer data saved in localStorage. If data already exists, use it. Otherwise use the default.
      if (window.localStorage.getItem('timersString') != null) {
        timers = JSON.parse(window.localStorage.getItem('timersString'));
      } else {
        // Clone the default value into timers with a little workaround.
        timers = JSON.parse(JSON.stringify(defaultTimers));
      }

      /*
      ================================
       FUNCTIONS
      ================================
      */

      // Start timer
      function start() {
        // Stop all other timers
        stop();
        // Get ID of timer to start
        const id = (event.srcElement.parentElement.dataset.id);
        // Set the start timestamp to now
        timers[id].lastTick = Date.now();
        // Set the timer running flag to true
        timers[id].running = true;
      }

      // Stop (all) timers
      // Loop through all timers and set the running flags to false
      function stop() {
        for (var key of Object.keys(timers)) {
          timers[key].running = false;
          document.querySelector('.timer[data-id="'+key+'"] span.status').innerText = '';
        }
      }

      // Ticker
      function tick() {
        console.log('tick');
        // Loop through all timers and check if the running flag is true
        for (var key of Object.keys(timers)) {
          if (timers[key].running) {
            // Calculate the elapsed time by the difference of the last tick and now
            var elapsed = (Date.now() - timers[key].lastTick);
            // Reset the last tick
            timers[key].lastTick = Date.now();
            // Add the accumulated time
            timers[key].totalTime = parseInt(timers[key].totalTime) + elapsed;
            // Update the status
            document.querySelector('.timer[data-id="'+key+'"] span.status').innerText = ' [running] ';
            // Update the displayed time in minutes
            document.querySelector('.timer[data-id="'+key+'"] span.totaltime').innerText = Math.floor(timers[key].totalTime/60000);
          }
        }
        // update localStorage
        updateLocalStorage();
      }

      // Initialize displayed timers
      function initTimers() {
        // Clear any old HTML
        let container = document.getElementById("timers");
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        // Loop through all timers, add HTML elements for each one.
        for (var key of Object.keys(timers)) {
          addElement(key);
        }
      }

      // Build displayed timers
      function addElement(key) {
        let newKey;
        // If this is called from the "Add Timer" button click, the key will be undefined.
        // Find the highest existing key and increment by one.
        if (key == undefined) {
          const highestKey = Math.max(...Object.keys(timers));
          newKey = Object.keys(timers).length > 0 ? highestKey + 1 : 1;
          timers[newKey] = {
            'title' : '',
            'description' : '',
            'running': false,
            'totalTime':'0'
          };
        // If this is called from the initializer, use the key that is passed as a paramater,
        } else {
          newKey = key;
        }

        // Build HTML elements
        const newTimer = document.createElement("div");
        newTimer.setAttribute('class','timer');
        newTimer.dataset.id = newKey;

        const title = document.createElement("input");
        title.value = timers[newKey].title;


        const description = document.createElement("textarea");
        description.value = timers[newKey].description;

        const start = document.createElement("button");
        start.name="Start";
        start.innerText="Start";
        start.setAttribute("onclick", "start()");

        const stop = document.createElement("button");
        stop.name="Stop";
        stop.innerText="Stop";
        stop.setAttribute("onclick", "stop()");

        const status = document.createElement("span");
        status.setAttribute('class','status');

        const elapsed = document.createElement("span");
        elapsed.setAttribute('class','totaltime');
        elapsed.innerText = Math.floor(timers[newKey].totalTime/60000);

        // Append HTML elements
        document.getElementById("timers").appendChild(newTimer);
        newTimer.appendChild(title);
        newTimer.appendChild(description);
        newTimer.appendChild(start);
        newTimer.appendChild(stop);
        newTimer.appendChild(status);
        newTimer.appendChild(elapsed);
      }

      // Clear all timers
      function clearAll() {
        // Stop all timers
        stop();
        // Clear timers object
        // (Clone the default value into timers)
        timers = JSON.parse(JSON.stringify(defaultTimers));
        console.log('--defaultTimers--');
        console.log(defaultTimers);
        console.log('--timers--');
        console.log(timers);
        // Clear localStorage
        window.localStorage.removeItem('timersString');
        // Re-initialize displayed timers
        initTimers();
      }

      // Update localStorage for data persistence
      function updateLocalStorage() {
        window.localStorage.setItem('timersString', JSON.stringify(timers));
      }


      /*
      ================================
       RUN
      ================================
      */

      window.addEventListener('DOMContentLoaded', function() {
          initTimers();
          setInterval(tick, 5000);
      });
    </script>

    <style media="screen">

    </style>

  </head>
  <body>
      <button type="button" name="add" onclick="addElement()">Add Timer</button>
      <button type="button" name="clear" onclick="clearAll()">Clear All Timers</button>
      <div id="timers">
      </div>
  </body>
</html>
